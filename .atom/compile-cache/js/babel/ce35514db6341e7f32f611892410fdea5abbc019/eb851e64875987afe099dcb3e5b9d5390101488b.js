Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.reactFactory = reactFactory;
exports.focus = focus;

var openOrShowDock = _asyncToGenerator(function* (URI) {
  // atom.workspace.open(URI) will activate/focus the dock by default
  // dock.toggle() or dock.show() will leave focus wherever it was

  // this function is basically workspace.open, except it
  // will not focus the newly opened pane
  var dock = atom.workspace.paneContainerForURI(URI);
  if (dock) return dock.show();

  yield atom.workspace.open(URI, {
    searchAllPanes: true,
    activatePane: false
  });
  dock = atom.workspace.paneContainerForURI(URI);
  return dock ? dock.show() : null;
});

exports.openOrShowDock = openOrShowDock;
exports.grammarToLanguage = grammarToLanguage;
exports.msgSpecToNotebookFormat = msgSpecToNotebookFormat;
exports.msgSpecV4toV5 = msgSpecV4toV5;
exports.isMultilanguageGrammar = isMultilanguageGrammar;
exports.kernelSpecProvidesGrammar = kernelSpecProvidesGrammar;
exports.getEmbeddedScope = getEmbeddedScope;
exports.getEditorDirectory = getEditorDirectory;
exports.log = log;
exports.renderDevTools = renderDevTools;
exports.hotReloadPackage = hotReloadPackage;
exports.rowRangeForCodeFoldAtBufferRow = rowRangeForCodeFoldAtBufferRow;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, "next"); var callThrow = step.bind(null, "throw"); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _atom = require("atom");

var _react = require("react");

var _react2 = _interopRequireDefault(_react);

var _reactDom = require("react-dom");

var _reactDom2 = _interopRequireDefault(_reactDom);

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _os = require("os");

var _os2 = _interopRequireDefault(_os);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _config = require("./config");

var _config2 = _interopRequireDefault(_config);

var _store = require("./store");

var _store2 = _interopRequireDefault(_store);

var INSPECTOR_URI = "atom://hydrogen/inspector";
exports.INSPECTOR_URI = INSPECTOR_URI;
var WATCHES_URI = "atom://hydrogen/watch-sidebar";
exports.WATCHES_URI = WATCHES_URI;
var OUTPUT_AREA_URI = "atom://hydrogen/output-area";
exports.OUTPUT_AREA_URI = OUTPUT_AREA_URI;
var KERNEL_MONITOR_URI = "atom://hydrogen/kernel-monitor";

exports.KERNEL_MONITOR_URI = KERNEL_MONITOR_URI;

function reactFactory(reactElement, domElement, additionalTeardown) {
  var disposer = arguments.length <= 3 || arguments[3] === undefined ? _store2["default"].subscriptions : arguments[3];

  _reactDom2["default"].render(reactElement, domElement);

  var disposable = new _atom.Disposable(function () {
    _reactDom2["default"].unmountComponentAtNode(domElement);
    if (typeof additionalTeardown === "function") additionalTeardown();
  });

  disposer.add(disposable);
}

function focus(item) {
  if (item) {
    var editorPane = atom.workspace.paneForItem(item);
    if (editorPane) editorPane.activate();
  }
}

function grammarToLanguage(grammar) {
  if (!grammar) return null;
  var grammarLanguage = grammar.name.toLowerCase();

  var mappings = _config2["default"].getJson("languageMappings");
  var kernelLanguage = _lodash2["default"].findKey(mappings, function (l) {
    return l.toLowerCase() === grammarLanguage;
  });

  return kernelLanguage ? kernelLanguage.toLowerCase() : grammarLanguage;
}

/**
 * Copied from https://github.com/nteract/nteract/blob/master/src/notebook/epics/execute.js#L37
 * Create an object that adheres to the jupyter notebook specification.
 * http://jupyter-client.readthedocs.io/en/latest/messaging.html
 *
 * @param {Object} msg - Message that has content which can be converted to nbformat
 * @return {Object} formattedMsg  - Message with the associated output type
 */

function msgSpecToNotebookFormat(message) {
  return Object.assign({}, message.content, {
    output_type: message.header.msg_type
  });
}

/**
 * A very basic converter for supporting jupyter messaging protocol v4 replies
 */

function msgSpecV4toV5(message) {
  switch (message.header.msg_type) {
    case "pyout":
      message.header.msg_type = "execute_result";
      break;
    case "pyerr":
      message.header.msg_type = "error";
      break;
    case "stream":
      if (!message.content.text) message.content.text = message.content.data;
      break;
  }
  return message;
}

var markupGrammars = new Set(["source.gfm", "source.asciidoc", "text.restructuredtext", "text.tex.latex.knitr", "text.md", "source.weave.noweb", "source.weave.md", "source.weave.latex", "source.weave.restructuredtext", "source.pweave.noweb", "source.pweave.md", "source.pweave.latex", "source.pweave.restructuredtext"]);

function isMultilanguageGrammar(grammar) {
  return markupGrammars.has(grammar.scopeName);
}

function kernelSpecProvidesGrammar(kernelSpec, grammar) {
  if (!grammar || !grammar.name || !kernelSpec || !kernelSpec.language) {
    return false;
  }
  var grammarLanguage = grammar.name.toLowerCase();
  var kernelLanguage = kernelSpec.language.toLowerCase();
  if (kernelLanguage === grammarLanguage) {
    return true;
  }

  var mappedLanguage = _config2["default"].getJson("languageMappings")[kernelLanguage];
  if (!mappedLanguage) {
    return false;
  }

  return mappedLanguage.toLowerCase() === grammarLanguage;
}

function getEmbeddedScope(editor, position) {
  var scopes = editor.scopeDescriptorForBufferPosition(position).getScopesArray();
  return _lodash2["default"].find(scopes, function (s) {
    return s.indexOf("source.embedded.") === 0;
  });
}

function getEditorDirectory(editor) {
  if (!editor) return _os2["default"].homedir();
  var editorPath = editor.getPath();
  return editorPath ? _path2["default"].dirname(editorPath) : _os2["default"].homedir();
}

function log() {
  if (atom.config.get("Hydrogen.debug")) {
    for (var _len = arguments.length, message = Array(_len), _key = 0; _key < _len; _key++) {
      message[_key] = arguments[_key];
    }

    console.debug.apply(console, ["Hydrogen:"].concat(message));
  }
}

function renderDevTools(enableLogging) {
  if (!atom.devMode) return;
  try {
    var devTools = require("mobx-react-devtools");
    var div = document.createElement("div");
    document.getElementsByTagName("body")[0].appendChild(div);
    devTools.setLogEnabled(enableLogging);
    _reactDom2["default"].render(_react2["default"].createElement(devTools["default"], { noPanel: true }), div);
  } catch (e) {
    log("Could not enable dev tools", e);
  }
}

function hotReloadPackage() {
  var packName = "Hydrogen";
  var packPath = atom.packages.resolvePackagePath(packName);
  if (!packPath) return;
  var packPathPrefix = packPath + _path2["default"].sep;
  var zeromqPathPrefix = _path2["default"].join(packPath, "node_modules", "zeromq") + _path2["default"].sep;

  console.info("deactivating " + packName);
  atom.packages.deactivatePackage(packName);
  atom.packages.unloadPackage(packName);

  // Delete require cache to re-require on activation.
  // But except zeromq native module which is not re-requireable.
  var packageLibsExceptZeromq = function packageLibsExceptZeromq(filePath) {
    return filePath.startsWith(packPathPrefix) && !filePath.startsWith(zeromqPathPrefix);
  };

  Object.keys(require.cache).filter(packageLibsExceptZeromq).forEach(function (filePath) {
    return delete require.cache[filePath];
  });

  atom.packages.loadPackage(packName);
  atom.packages.activatePackage(packName);
  console.info("activated " + packName);
}

function rowRangeForCodeFoldAtBufferRow(editor, row) {
  if (parseFloat(atom.getVersion()) < 1.22) {
    return editor.languageMode.rowRangeForCodeFoldAtBufferRow(row);
  } else {
    // $FlowFixMe
    var range = editor.tokenizedBuffer.getFoldableRangeContainingPoint(new _atom.Point(row, Infinity), editor.getTabLength());

    return range ? [range.start.row, range.end.row] : null;
  }
}

var EmptyMessage = function EmptyMessage() {
  return _react2["default"].createElement(
    "ul",
    { className: "background-message centered" },
    _react2["default"].createElement(
      "li",
      null,
      "No output to display"
    )
  );
};
exports.EmptyMessage = EmptyMessage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2tuaWVsYm8vLmF0b20vcGFja2FnZXMvSHlkcm9nZW4vbGliL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztJQXdDc0IsY0FBYyxxQkFBN0IsV0FBOEIsR0FBVyxFQUFrQjs7Ozs7O0FBTWhFLE1BQUksSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkQsTUFBSSxJQUFJLEVBQUUsT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7O0FBRTdCLFFBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBQzdCLGtCQUFjLEVBQUUsSUFBSTtBQUNwQixnQkFBWSxFQUFFLEtBQUs7R0FDcEIsQ0FBQyxDQUFDO0FBQ0gsTUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDL0MsU0FBTyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQztDQUNsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFyRGlDLE1BQU07O3FCQUN0QixPQUFPOzs7O3dCQUNKLFdBQVc7Ozs7c0JBQ2xCLFFBQVE7Ozs7a0JBQ1AsSUFBSTs7OztvQkFDRixNQUFNOzs7O3NCQUVKLFVBQVU7Ozs7cUJBQ1gsU0FBUzs7OztBQUVwQixJQUFNLGFBQWEsR0FBRywyQkFBMkIsQ0FBQzs7QUFDbEQsSUFBTSxXQUFXLEdBQUcsK0JBQStCLENBQUM7O0FBQ3BELElBQU0sZUFBZSxHQUFHLDZCQUE2QixDQUFDOztBQUN0RCxJQUFNLGtCQUFrQixHQUFHLGdDQUFnQyxDQUFDOzs7O0FBRTVELFNBQVMsWUFBWSxDQUMxQixZQUFnQyxFQUNoQyxVQUF1QixFQUN2QixrQkFBNkIsRUFFN0I7TUFEQSxRQUFrQyx5REFBRyxtQkFBTSxhQUFhOztBQUV4RCx3QkFBUyxNQUFNLENBQUMsWUFBWSxFQUFFLFVBQVUs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QU0sWUFBWSxHQUFHLFNBQWYsWUFBWSxHQUFTO0FBQ2hDLFNBQ0U7O01BQUksU0FBUyxFQUFDLDZCQUE2QjtJQUN6Qzs7OztLQUE2QjtHQUMxQixDQUNMO0NBQ0gsQ0FBQyIsImZpbGUiOiIvaG9tZS9rbmllbGJvLy5hdG9tL3BhY2thZ2VzL0h5ZHJvZ2VuL2xpYi91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCB7IERpc3Bvc2FibGUsIFBvaW50IH0gZnJvbSBcImF0b21cIjtcbmltcG9ydCBSZWFjdCBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBSZWFjdERPTSBmcm9tIFwicmVhY3QtZG9tXCI7XG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuXG5pbXBvcnQgQ29uZmlnIGZyb20gXCIuL2NvbmZpZ1wiO1xuaW1wb3J0IHN0b3JlIGZyb20gXCIuL3N0b3JlXCI7XG5cbmV4cG9ydCBjb25zdCBJTlNQRUNUT1JfVVJJID0gXCJhdG9tOi8vaHlkcm9nZW4vaW5zcGVjdG9yXCI7XG5leHBvcnQgY29uc3QgV0FUQ0hFU19VUkkgPSBcImF0b206Ly9oeWRyb2dlbi93YXRjaC1zaWRlYmFyXCI7XG5leHBvcnQgY29uc3QgT1VUUFVUX0FSRUFfVVJJID0gXCJhdG9tOi8vaHlkcm9nZW4vb3V0cHV0LWFyZWFcIjtcbmV4cG9ydCBjb25zdCBLRVJORUxfTU9OSVRPUl9VUkkgPSBcImF0b206Ly9oeWRyb2dlbi9rZXJuZWwtbW9uaXRvclwiO1xuXG5leHBvcnQgZnVuY3Rpb24gcmVhY3RGYWN0b3J5KFxuICByZWFjdEVsZW1lbnQ6IFJlYWN0JEVsZW1lbnQ8YW55PixcbiAgZG9tRWxlbWVudDogSFRNTEVsZW1lbnQsXG4gIGFkZGl0aW9uYWxUZWFyZG93bjogP0Z1bmN0aW9uLFxuICBkaXNwb3NlcjogYXRvbSRDb21wb3NpdGVEaXNwb3NhYmxlID0gc3RvcmUuc3Vic2NyaXB0aW9uc1xuKSB7XG4gIFJlYWN0RE9NLnJlbmRlcihyZWFjdEVsZW1lbnQsIGRvbUVsZW1lbnQpO1xuXG4gIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZShkb21FbGVtZW50KTtcbiAgICBpZiAodHlwZW9mIGFkZGl0aW9uYWxUZWFyZG93biA9PT0gXCJmdW5jdGlvblwiKSBhZGRpdGlvbmFsVGVhcmRvd24oKTtcbiAgfSk7XG5cbiAgZGlzcG9zZXIuYWRkKGRpc3Bvc2FibGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9jdXMoaXRlbTogP21peGVkKSB7XG4gIGlmIChpdGVtKSB7XG4gICAgY29uc3QgZWRpdG9yUGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pO1xuICAgIGlmIChlZGl0b3JQYW5lKSBlZGl0b3JQYW5lLmFjdGl2YXRlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG9wZW5PclNob3dEb2NrKFVSSTogc3RyaW5nKTogUHJvbWlzZTw/dm9pZD4ge1xuICAvLyBhdG9tLndvcmtzcGFjZS5vcGVuKFVSSSkgd2lsbCBhY3RpdmF0ZS9mb2N1cyB0aGUgZG9jayBieSBkZWZhdWx0XG4gIC8vIGRvY2sudG9nZ2xlKCkgb3IgZG9jay5zaG93KCkgd2lsbCBsZWF2ZSBmb2N1cyB3aGVyZXZlciBpdCB3YXNcblxuICAvLyB0aGlzIGZ1bmN0aW9uIGlzIGJhc2ljYWxseSB3b3Jrc3BhY2Uub3BlbiwgZXhjZXB0IGl0XG4gIC8vIHdpbGwgbm90IGZvY3VzIHRoZSBuZXdseSBvcGVuZWQgcGFuZVxuICBsZXQgZG9jayA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JVUkkoVVJJKTtcbiAgaWYgKGRvY2spIHJldHVybiBkb2NrLnNob3coKTtcblxuICBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKFVSSSwge1xuICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICAgIGFjdGl2YXRlUGFuZTogZmFsc2VcbiAgfSk7XG4gIGRvY2sgPSBhdG9tLndvcmtzcGFjZS5wYW5lQ29udGFpbmVyRm9yVVJJKFVSSSk7XG4gIHJldHVybiBkb2NrID8gZG9jay5zaG93KCkgOiBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ3JhbW1hclRvTGFuZ3VhZ2UoZ3JhbW1hcjogP2F0b20kR3JhbW1hcikge1xuICBpZiAoIWdyYW1tYXIpIHJldHVybiBudWxsO1xuICBjb25zdCBncmFtbWFyTGFuZ3VhZ2UgPSBncmFtbWFyLm5hbWUudG9Mb3dlckNhc2UoKTtcblxuICBjb25zdCBtYXBwaW5ncyA9IENvbmZpZy5nZXRKc29uKFwibGFuZ3VhZ2VNYXBwaW5nc1wiKTtcbiAgY29uc3Qga2VybmVsTGFuZ3VhZ2UgPSBfLmZpbmRLZXkoXG4gICAgbWFwcGluZ3MsXG4gICAgbCA9PiBsLnRvTG93ZXJDYXNlKCkgPT09IGdyYW1tYXJMYW5ndWFnZVxuICApO1xuXG4gIHJldHVybiBrZXJuZWxMYW5ndWFnZSA/IGtlcm5lbExhbmd1YWdlLnRvTG93ZXJDYXNlKCkgOiBncmFtbWFyTGFuZ3VhZ2U7XG59XG5cbi8qKlxuICogQ29waWVkIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL250ZXJhY3QvbnRlcmFjdC9ibG9iL21hc3Rlci9zcmMvbm90ZWJvb2svZXBpY3MvZXhlY3V0ZS5qcyNMMzdcbiAqIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhZGhlcmVzIHRvIHRoZSBqdXB5dGVyIG5vdGVib29rIHNwZWNpZmljYXRpb24uXG4gKiBodHRwOi8vanVweXRlci1jbGllbnQucmVhZHRoZWRvY3MuaW8vZW4vbGF0ZXN0L21lc3NhZ2luZy5odG1sXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG1zZyAtIE1lc3NhZ2UgdGhhdCBoYXMgY29udGVudCB3aGljaCBjYW4gYmUgY29udmVydGVkIHRvIG5iZm9ybWF0XG4gKiBAcmV0dXJuIHtPYmplY3R9IGZvcm1hdHRlZE1zZyAgLSBNZXNzYWdlIHdpdGggdGhlIGFzc29jaWF0ZWQgb3V0cHV0IHR5cGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1zZ1NwZWNUb05vdGVib29rRm9ybWF0KG1lc3NhZ2U6IE1lc3NhZ2UpIHtcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIG1lc3NhZ2UuY29udGVudCwge1xuICAgIG91dHB1dF90eXBlOiBtZXNzYWdlLmhlYWRlci5tc2dfdHlwZVxuICB9KTtcbn1cblxuLyoqXG4gKiBBIHZlcnkgYmFzaWMgY29udmVydGVyIGZvciBzdXBwb3J0aW5nIGp1cHl0ZXIgbWVzc2FnaW5nIHByb3RvY29sIHY0IHJlcGxpZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1zZ1NwZWNWNHRvVjUobWVzc2FnZTogTWVzc2FnZSkge1xuICBzd2l0Y2ggKG1lc3NhZ2UuaGVhZGVyLm1zZ190eXBlKSB7XG4gICAgY2FzZSBcInB5b3V0XCI6XG4gICAgICBtZXNzYWdlLmhlYWRlci5tc2dfdHlwZSA9IFwiZXhlY3V0ZV9yZXN1bHRcIjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgXCJweWVyclwiOlxuICAgICAgbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUgPSBcImVycm9yXCI7XG4gICAgICBicmVhaztcbiAgICBjYXNlIFwic3RyZWFtXCI6XG4gICAgICBpZiAoIW1lc3NhZ2UuY29udGVudC50ZXh0KSBtZXNzYWdlLmNvbnRlbnQudGV4dCA9IG1lc3NhZ2UuY29udGVudC5kYXRhO1xuICAgICAgYnJlYWs7XG4gIH1cbiAgcmV0dXJuIG1lc3NhZ2U7XG59XG5cbmNvbnN0IG1hcmt1cEdyYW1tYXJzID0gbmV3IFNldChbXG4gIFwic291cmNlLmdmbVwiLFxuICBcInNvdXJjZS5hc2NpaWRvY1wiLFxuICBcInRleHQucmVzdHJ1Y3R1cmVkdGV4dFwiLFxuICBcInRleHQudGV4LmxhdGV4LmtuaXRyXCIsXG4gIFwidGV4dC5tZFwiLFxuICBcInNvdXJjZS53ZWF2ZS5ub3dlYlwiLFxuICBcInNvdXJjZS53ZWF2ZS5tZFwiLFxuICBcInNvdXJjZS53ZWF2ZS5sYXRleFwiLFxuICBcInNvdXJjZS53ZWF2ZS5yZXN0cnVjdHVyZWR0ZXh0XCIsXG4gIFwic291cmNlLnB3ZWF2ZS5ub3dlYlwiLFxuICBcInNvdXJjZS5wd2VhdmUubWRcIixcbiAgXCJzb3VyY2UucHdlYXZlLmxhdGV4XCIsXG4gIFwic291cmNlLnB3ZWF2ZS5yZXN0cnVjdHVyZWR0ZXh0XCJcbl0pO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNNdWx0aWxhbmd1YWdlR3JhbW1hcihncmFtbWFyOiBhdG9tJEdyYW1tYXIpIHtcbiAgcmV0dXJuIG1hcmt1cEdyYW1tYXJzLmhhcyhncmFtbWFyLnNjb3BlTmFtZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBrZXJuZWxTcGVjUHJvdmlkZXNHcmFtbWFyKFxuICBrZXJuZWxTcGVjOiBLZXJuZWxzcGVjLFxuICBncmFtbWFyOiA/YXRvbSRHcmFtbWFyXG4pIHtcbiAgaWYgKCFncmFtbWFyIHx8ICFncmFtbWFyLm5hbWUgfHwgIWtlcm5lbFNwZWMgfHwgIWtlcm5lbFNwZWMubGFuZ3VhZ2UpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgY29uc3QgZ3JhbW1hckxhbmd1YWdlID0gZ3JhbW1hci5uYW1lLnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IGtlcm5lbExhbmd1YWdlID0ga2VybmVsU3BlYy5sYW5ndWFnZS50b0xvd2VyQ2FzZSgpO1xuICBpZiAoa2VybmVsTGFuZ3VhZ2UgPT09IGdyYW1tYXJMYW5ndWFnZSkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgY29uc3QgbWFwcGVkTGFuZ3VhZ2UgPSBDb25maWcuZ2V0SnNvbihcImxhbmd1YWdlTWFwcGluZ3NcIilba2VybmVsTGFuZ3VhZ2VdO1xuICBpZiAoIW1hcHBlZExhbmd1YWdlKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIG1hcHBlZExhbmd1YWdlLnRvTG93ZXJDYXNlKCkgPT09IGdyYW1tYXJMYW5ndWFnZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVtYmVkZGVkU2NvcGUoXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICBwb3NpdGlvbjogYXRvbSRQb2ludFxuKTogP3N0cmluZyB7XG4gIGNvbnN0IHNjb3BlcyA9IGVkaXRvclxuICAgIC5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihwb3NpdGlvbilcbiAgICAuZ2V0U2NvcGVzQXJyYXkoKTtcbiAgcmV0dXJuIF8uZmluZChzY29wZXMsIHMgPT4gcy5pbmRleE9mKFwic291cmNlLmVtYmVkZGVkLlwiKSA9PT0gMCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFZGl0b3JEaXJlY3RvcnkoZWRpdG9yOiA/YXRvbSRUZXh0RWRpdG9yKSB7XG4gIGlmICghZWRpdG9yKSByZXR1cm4gb3MuaG9tZWRpcigpO1xuICBjb25zdCBlZGl0b3JQYXRoID0gZWRpdG9yLmdldFBhdGgoKTtcbiAgcmV0dXJuIGVkaXRvclBhdGggPyBwYXRoLmRpcm5hbWUoZWRpdG9yUGF0aCkgOiBvcy5ob21lZGlyKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2coLi4ubWVzc2FnZTogQXJyYXk8YW55Pikge1xuICBpZiAoYXRvbS5jb25maWcuZ2V0KFwiSHlkcm9nZW4uZGVidWdcIikpIHtcbiAgICBjb25zb2xlLmRlYnVnKFwiSHlkcm9nZW46XCIsIC4uLm1lc3NhZ2UpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJEZXZUb29scyhlbmFibGVMb2dnaW5nOiBib29sZWFuKSB7XG4gIGlmICghYXRvbS5kZXZNb2RlKSByZXR1cm47XG4gIHRyeSB7XG4gICAgY29uc3QgZGV2VG9vbHMgPSByZXF1aXJlKFwibW9ieC1yZWFjdC1kZXZ0b29sc1wiKTtcbiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiYm9keVwiKVswXS5hcHBlbmRDaGlsZChkaXYpO1xuICAgIGRldlRvb2xzLnNldExvZ0VuYWJsZWQoZW5hYmxlTG9nZ2luZyk7XG4gICAgUmVhY3RET00ucmVuZGVyKDxkZXZUb29scy5kZWZhdWx0IG5vUGFuZWwgLz4sIGRpdik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2coXCJDb3VsZCBub3QgZW5hYmxlIGRldiB0b29sc1wiLCBlKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaG90UmVsb2FkUGFja2FnZSgpIHtcbiAgY29uc3QgcGFja05hbWUgPSBcIkh5ZHJvZ2VuXCI7XG4gIGNvbnN0IHBhY2tQYXRoID0gYXRvbS5wYWNrYWdlcy5yZXNvbHZlUGFja2FnZVBhdGgocGFja05hbWUpO1xuICBpZiAoIXBhY2tQYXRoKSByZXR1cm47XG4gIGNvbnN0IHBhY2tQYXRoUHJlZml4ID0gcGFja1BhdGggKyBwYXRoLnNlcDtcbiAgY29uc3QgemVyb21xUGF0aFByZWZpeCA9XG4gICAgcGF0aC5qb2luKHBhY2tQYXRoLCBcIm5vZGVfbW9kdWxlc1wiLCBcInplcm9tcVwiKSArIHBhdGguc2VwO1xuXG4gIGNvbnNvbGUuaW5mbyhgZGVhY3RpdmF0aW5nICR7cGFja05hbWV9YCk7XG4gIGF0b20ucGFja2FnZXMuZGVhY3RpdmF0ZVBhY2thZ2UocGFja05hbWUpO1xuICBhdG9tLnBhY2thZ2VzLnVubG9hZFBhY2thZ2UocGFja05hbWUpO1xuXG4gIC8vIERlbGV0ZSByZXF1aXJlIGNhY2hlIHRvIHJlLXJlcXVpcmUgb24gYWN0aXZhdGlvbi5cbiAgLy8gQnV0IGV4Y2VwdCB6ZXJvbXEgbmF0aXZlIG1vZHVsZSB3aGljaCBpcyBub3QgcmUtcmVxdWlyZWFibGUuXG4gIGNvbnN0IHBhY2thZ2VMaWJzRXhjZXB0WmVyb21xID0gZmlsZVBhdGggPT5cbiAgICBmaWxlUGF0aC5zdGFydHNXaXRoKHBhY2tQYXRoUHJlZml4KSAmJlxuICAgICFmaWxlUGF0aC5zdGFydHNXaXRoKHplcm9tcVBhdGhQcmVmaXgpO1xuXG4gIE9iamVjdC5rZXlzKHJlcXVpcmUuY2FjaGUpXG4gICAgLmZpbHRlcihwYWNrYWdlTGlic0V4Y2VwdFplcm9tcSlcbiAgICAuZm9yRWFjaChmaWxlUGF0aCA9PiBkZWxldGUgcmVxdWlyZS5jYWNoZVtmaWxlUGF0aF0pO1xuXG4gIGF0b20ucGFja2FnZXMubG9hZFBhY2thZ2UocGFja05hbWUpO1xuICBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZShwYWNrTmFtZSk7XG4gIGNvbnNvbGUuaW5mbyhgYWN0aXZhdGVkICR7cGFja05hbWV9YCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3coXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxuICByb3c6IG51bWJlclxuKSB7XG4gIGlmIChwYXJzZUZsb2F0KGF0b20uZ2V0VmVyc2lvbigpKSA8IDEuMjIpIHtcbiAgICByZXR1cm4gZWRpdG9yLmxhbmd1YWdlTW9kZS5yb3dSYW5nZUZvckNvZGVGb2xkQXRCdWZmZXJSb3cocm93KTtcbiAgfSBlbHNlIHtcbiAgICAvLyAkRmxvd0ZpeE1lXG4gICAgY29uc3QgcmFuZ2UgPSBlZGl0b3IudG9rZW5pemVkQnVmZmVyLmdldEZvbGRhYmxlUmFuZ2VDb250YWluaW5nUG9pbnQoXG4gICAgICBuZXcgUG9pbnQocm93LCBJbmZpbml0eSksXG4gICAgICBlZGl0b3IuZ2V0VGFiTGVuZ3RoKClcbiAgICApO1xuXG4gICAgcmV0dXJuIHJhbmdlID8gW3JhbmdlLnN0YXJ0LnJvdywgcmFuZ2UuZW5kLnJvd10gOiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBFbXB0eU1lc3NhZ2UgPSAoKSA9PiB7XG4gIHJldHVybiAoXG4gICAgPHVsIGNsYXNzTmFtZT1cImJhY2tncm91bmQtbWVzc2FnZSBjZW50ZXJlZFwiPlxuICAgICAgPGxpPk5vIG91dHB1dCB0byBkaXNwbGF5PC9saT5cbiAgICA8L3VsPlxuICApO1xufTtcbiJdfQ==